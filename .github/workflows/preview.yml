name: Preview Deploy â€” Branch

on:
  push:
    branches-ignore: [main]

# One preview build per branch at a time
concurrency:
  group: preview-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: write        # push to gh-pages
  pull-requests: write   # post/update PR comment

jobs:
  preview:
    name: Build & deploy preview
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: projects/**/package-lock.json

      # Convert branch name to a URL-safe slug
      # e.g. "copilot/my-feature" â†’ "copilot-my-feature"
      - name: Compute branch slug
        id: slug
        run: |
          SLUG=$(echo "${{ github.ref_name }}" \
            | tr '[:upper:]' '[:lower:]' \
            | sed 's|[^a-z0-9-]|-|g' \
            | sed 's|-\+|-|g' \
            | sed 's|^-||' \
            | sed 's|-$||')
          echo "value=${SLUG}" >> "$GITHUB_OUTPUT"

      # Build Vite projects with a preview-specific base path so asset URLs
      # resolve correctly under /clayground/preview/<slug>/<project>/.
      # Non-Vite projects (e.g. Storybook) are built normally.
      - name: Build all projects for preview
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        run: |
          SLUG="${{ steps.slug.outputs.value }}"
          for dir in projects/*/; do
            if [ ! -f "${dir}package.json" ]; then continue; fi
            PROJECT=$(basename "$dir")
            if [ -f "${dir}vite.config.ts" ]; then
              echo "â–¶ Building ${PROJECT} (Vite) for preview/${SLUG}/${PROJECT}/"
              (cd "${dir}" && npm ci && \
                npx vite build --base "/clayground/preview/${SLUG}/${PROJECT}/")
            else
              echo "â–¶ Building ${PROJECT}"
              (cd "${dir}" && npm ci && npm run build)
            fi
          done

      # Push docs/ into gh-pages/preview/<slug>/ without touching other
      # top-level directories (keep_files: true).
      - name: Deploy preview to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          destination_dir: preview/${{ steps.slug.outputs.value }}
          keep_files: true

      # Post or update a single "Preview deployment" comment on the PR
      - name: Comment preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const slug = '${{ steps.slug.outputs.value }}';
            const branch = '${{ github.ref_name }}';
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const url = `https://${owner}.github.io/clayground/preview/${slug}/`;
            const marker = '<!-- clayground-preview -->';
            const body = [
              marker,
              '### ðŸ” Preview deployment',
              '',
              `**Branch:** \`${branch}\``,
              `**URL:** ${url}`,
              '',
              '> This preview is rebuilt on every push to this branch and removed when the branch is deleted.',
            ].join('\n');

            // Find open PRs for this branch
            const { data: prs } = await github.rest.pulls.list({
              owner, repo, state: 'open',
              head: `${owner}:${branch}`,
            });
            if (prs.length === 0) return; // no open PR â€” skip comment

            const prNumber = prs[0].number;
            const { data: comments } = await github.rest.issues.listComments({
              owner, repo, issue_number: prNumber,
            });
            const existing = comments.find(c => c.body?.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner, repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner, repo,
                issue_number: prNumber,
                body,
              });
            }
