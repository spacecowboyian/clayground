name: Preview Cleanup — Branch Deleted

on:
  # Fires when a branch or tag is deleted.
  # We only care about branch deletions.
  delete:

permissions:
  contents: write   # push to gh-pages

jobs:
  cleanup:
    name: Remove preview for deleted branch
    # Only run for branch deletions, not tag deletions
    if: github.event.ref_type == 'branch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: Compute branch slug
        id: slug
        run: |
          SLUG=$(echo "${{ github.event.ref }}" \
            | tr '[:upper:]' '[:lower:]' \
            | sed 's|[^a-z0-9-]|-|g' \
            | sed 's|-\+|-|g' \
            | sed 's|^-||' \
            | sed 's|-$||')
          echo "value=${SLUG}" >> "$GITHUB_OUTPUT"

      - name: Delete preview folder
        run: |
          SLUG="${{ steps.slug.outputs.value }}"
          if [ -d "preview/${SLUG}" ]; then
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git config user.name "github-actions[bot]"
            git rm -rf "preview/${SLUG}"
            git commit -m "ci: remove preview for ${SLUG}"
            git push
          else
            echo "No preview folder found for preview/${SLUG} — nothing to clean up."
          fi
